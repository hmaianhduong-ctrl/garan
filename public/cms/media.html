<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Library | Elis Favorite CMS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#BA3801', 
                        'accent': '#FFEDA8',
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; padding-top: 72px; }
        
        /* HEADER CSS */
        header { position: fixed; top: 0; left: 0; width: 100%; height: 72px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-sizing: border-box; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.08); z-index: 1000; }
        .logo { width: 200px; height: 60px; object-fit: contain; content: url('https://i.postimg.cc/7b4MF0XW/logo-colored.png'); }
        nav { display: flex; align-items: center; gap: 66px; }
        nav a { font-size: 22px; color: #ba3801; text-transform: uppercase; font-weight: 300; text-decoration: none; height: 40px; display: flex; align-items: center; transition: color 0.4s ease; }
        nav a.active-nav { font-weight: 700; border-bottom: 3px solid #BA3801; }
        
        /* User Menu */
        .user-menu-container { position: relative; height: 40px; display: flex; align-items: center; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid #ba3801; }
        .logout-dropdown { position: absolute; top: 100%; right: 0; margin-top: 10px; background-color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); border-radius: 8px; min-width: 150px; padding: 5px 0; z-index: 1001; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s; }
        .logout-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .logout-link { font-size: 14px; font-weight: 600; color: #ba3801 !important; padding: 8px 16px; width: 100%; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .logout-link:hover { background-color: #ffeda8; }

        /* Copy Message */
        .copied-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #059669; color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; transition: all 0.3s; z-index: 2000; }
        .copied-message.show { opacity: 1; transform: translate(-50%, -10px); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header id="header">
        <a href="dashboard.html"><img id="logo" class="logo" src="https://i.postimg.cc/7b4MF0XW/logo-colored.png" alt="Elis Logo" /></a>
        <nav>
            <a href="posts.html">Posts</a>
            <a href="comments.html">Comments</a>
            <a href="media.html" class="active-nav">Media</a>
            <div id="user-menu" class="user-menu-container">
                <img id="user-avatar" class="user-avatar" src="https://i.postimg.cc/VvFj0vXz/admin-avatar.jpg" alt="User Avatar" />
                <div id="logout-dropdown" class="logout-dropdown">
                    <a href="login.html" class="logout-link"><i class="fas fa-sign-out-alt"></i> LOG OUT</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="font-sans pt-12 pb-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-6 pt-6">
                <h2 class="text-4xl font-extrabold text-gray-900">
                    <span class="text-sm font-medium text-primary block mb-1">Quản lý nội dung</span>
                    All Media
                </h2>
                
                <label for="upload-input" class="cursor-pointer bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors flex items-center space-x-2">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span id="upload-label-text">Upload ảnh mới</span>
                </label>
                <input type="file" id="upload-input" accept="image/*" class="hidden" multiple onchange="handleImageUpload(event)">
            </div>

            <div id="media-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
                </div>

            <div id="copied-message" class="copied-message">
                <i class="fas fa-check-circle mr-2"></i> Link ảnh đã được sao chép!
            </div>
        </div>
    </main>

    <script>
        // --- CẤU HÌNH API ---
        const API_UPLOAD = '/api/upload'; // API này vừa upload vừa lưu DB
        const API_MEDIA = '/api/media';   // API này lấy danh sách và xóa

        const gallery = document.getElementById('media-gallery');
        const copiedMessage = document.getElementById('copied-message');

        // --- 1. HÀM TẢI DANH SÁCH ẢNH ---
        async function fetchAndRender() {
            try {
                const res = await fetch(API_MEDIA, { cache: 'no-store' });
                const mediaData = await res.json();
                renderGallery(mediaData);
            } catch (error) {
                console.error("Lỗi tải gallery:", error);
                gallery.innerHTML = '<div class="col-span-full text-center text-red-500">Lỗi kết nối server.</div>';
            }
        }

        // --- 2. HÀM RENDER HTML ---
        function renderGallery(mediaData) {
            gallery.innerHTML = '';
            
            if (!mediaData || mediaData.length === 0) {
                gallery.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500 text-lg">Chưa có ảnh nào.</div>';
                return;
            }

            mediaData.forEach(media => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'group relative bg-white rounded-lg shadow-lg overflow-hidden transition-shadow duration-300 hover:shadow-xl cursor-pointer';
                
                mediaItem.innerHTML = `
                    <img src="${media.url}" alt="Media ${media.id}" class="w-full h-40 object-cover transition-transform duration-500 group-hover:scale-105" />
                    
                    <div class="absolute inset-0 bg-black/50 flex flex-col justify-center items-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 space-y-2">
                        <button onclick="copyLink('${media.url}')" class="bg-white text-primary hover:bg-accent font-semibold py-2 px-4 rounded-full text-xs flex items-center">
                            <i class="fas fa-copy mr-2"></i> Copy
                        </button>
                        <button onclick="deleteMedia(${media.id})" class="bg-red-500 text-white hover:bg-red-600 font-semibold py-2 px-4 rounded-full text-xs flex items-center">
                            <i class="fas fa-trash-alt mr-2"></i> Xóa
                        </button>
                    </div>
                `;
                gallery.appendChild(mediaItem);
            });
        }

        // --- 3. XỬ LÝ UPLOAD (Gọn nhẹ hơn) ---
        async function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const labelSpan = document.getElementById('upload-label-text');
            const originalText = labelSpan.innerText;
            labelSpan.innerText = "Đang xử lý...";

            try {
                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);

                    // Gọi API Upload (Nó sẽ tự lưu vào DB luôn)
                    const res = await fetch(API_UPLOAD, {
                        method: 'POST',
                        body: formData
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        console.error('Lỗi upload:', err);
                        alert(`Lỗi upload file ${file.name}`);
                    }
                }
                
                // Upload xong hết thì tải lại gallery
                await fetchAndRender();
                alert('Hoàn tất upload!');

            } catch (error) {
                console.error(error);
                alert('Có lỗi xảy ra!');
            } finally {
                event.target.value = null; // Reset input
                labelSpan.innerText = originalText;
            }
        }

        // --- 4. CÁC HÀM SỰ KIỆN WINDOW ---
        window.deleteMedia = async (id) => {
            if (confirm('Bạn có chắc muốn xóa ảnh này vĩnh viễn?')) {
                try {
                    const res = await fetch(`${API_MEDIA}/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        fetchAndRender(); // Reload lại sau khi xóa
                    } else {
                        alert('Không thể xóa ảnh.');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Lỗi server.');
                }
            }
        };

        window.copyLink = (url) => {
            navigator.clipboard.writeText(url).then(() => {
                copiedMessage.classList.add('show');
                setTimeout(() => copiedMessage.classList.remove('show'), 1500);
            });
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRender();
            
            // Header dropdown logic
            const avatar = document.getElementById('user-avatar');
            const dropdown = document.getElementById('logout-dropdown');
            if (avatar && dropdown) {
                avatar.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
                document.addEventListener('click', (e) => { if (!avatar.contains(e.target)) dropdown.classList.remove('show'); });
            }
        });
    </script>
</body>
</html>